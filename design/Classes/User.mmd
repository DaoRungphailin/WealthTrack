sequenceDiagram
   title User Class
    participant Client
    participant Router
    participant UserController
    participant UserModel
    participant Security
    

    alt create a new user
        rect rgb(73,204,144)
            Note over Router: with body of {username, email,<br/>Password, confirmPass}
            Client->>Router: POST /user/create
            Router->>Router: extract the body (whatever it have or don't have)<br> by body parser to parameters
            Router->>UserController: register(username, email,<br>Password, confirmPass)
            UserController->>UserController: verify all pameters is not null 
            opt some parameter is null or empty
                UserController-->>Router: throw the error "parameters is required"
                Note over Router,Client: JSON Response: {status_code, message, data(if any)}
                Router-->>Client: 400, "username, email,<br> Password, and confirmPass are required"
            end
            UserController->>UserController: verify password matched
            opt password and confirm password doesn't match
                UserController-->>Router: throw the error "password don't match"
                Note over Router,Client: JSON Response: {status_code, message, data(if any)}
                Router-->>Client: 400, "password and its confirm don't match"
            end
            UserController->>UserController: verify email format
            opt invalid email format 
                UserController-->>Router: throw the error "invalid email"
                Note over Router,Client: JSON Response: {status_code, message, data(if any)}
                Router-->>Client: 400, "invalid email"
            end
            UserController->>UserController: normalize an email and username to lowercase<br> this.normalize(email, username)
            UserController->>UserModel: duplicate user verifying<br>verify_duplicate_user(username, email)
            Note over UserController, Security: this.search(searchCriteria: str, searchValue: str, one: <True, False>bool, sorting: <"asc", "desc">Sort)
            UserModel->>UserModel: verifying userName and eMail<br> if match any user<br>this.search("username", userName, True, "asc")<br>this.search("email, eMail, True, "asc")
            opt found user with the same email and username
                Note left of UserModel: return only non-sensitive data (user data: userUniqueId, memberSince, userName, email))
                UserModel-->>UserController: return user object {...}
                UserController-->>Router: throw the error "user duplicated"
                Note over Router,Client: JSON Response: {status_code, message, data(if any)}
                Router-->>Client: 409, "Conflict found"
            end
            UserModel->>UserController: return user empty object
            UserController->>UserController: hashing the password<br>bcrypt.hashpw(password, salt?)
            UserController->>UserController: create user object from parameters
            UserController->>UserController: add role fields to object
            Note over UserController, UserModel: New_User {userName, email, hashedPassword, role}
            UserController->>UserModel: create(db, newUser: New_User)
            UserModel->>UserModel: add member_since fields to newUser object
            opt Create user Failed
                UserModel-->>UserController: throw any error
                UserController-->>Router: throw the error "error occured during create a user"
                Note over Router,Client: JSON Response: {status_code, message, data(if any)}
                Router-->>Client: 500, "error occured during create a user"
            end
            UserModel->>UserController: return user created id: str
            opt any error
                UserController-->>Router: throw the error "internal server error"
                Note over Router,Client: JSON Response: {status_code, message, data(if any)}
                Router-->>Client: 500, "internal server error"
            end
            UserController->>Router: return user created id: str
            Note over Router,Client: JSON Response: {status_code, message, data(if any)}
            Router->>Client: 201, "user created", data: {id: userCreatedId}
        end
    else read current user
        rect rgb(142,172,252)
            Note over Router: with body of {request}
            Client->>Router: POST /user/current
            Router->>Router: extract the body (whatever it have or don't have)<br> by body parser to parameters
            Router->>UserController: get_current_user(request)
            UserController->>UserController: extract the token from cookie<br>in the request
            opt cookie not found
                UserController-->>Router: throw the error "mising token"
                Note over Router,Client: JSON Response: {status_code, message, data(if any)}
                Router-->>Client: 401, "mising token"
            end
            UserController->>Security: Security.decode_token(token)
            opt cannot decode token
                Security-->>UserController: throw the error "token decode error"
                UserController-->>Router: throw the error "error occured during get a current user"
                Note over Router,Client: JSON Response: {status_code, message, data(if any)}
                Router-->>Client: 500, "error occured during get a current user"
            end
            Security->>UserController: return isExpired, user object {...}
            opt token is expired or user object is empty
                UserController-->>Router: throw the error "Invalid token"
                Note over Router,Client: JSON Response: {status_code, message, data(if any)}
                 Router-->>Client: 401, "Invalid token"
            end
            opt any error
                UserController-->>Router: throw the error "internal server error"
                Note over Router,Client: JSON Response: {status_code, message, data(if any)}
                Router-->>Client: 500, "internal server error"
            end
            UserController->>Router: return user object {...}
            Router->>Client: 200, "get current user success", data: {user: user}
        end
    else search users
        rect rgb(253,164,255)
            Note right of Client: Adnim only
            Note over Router: with body of {searchCriteria, searchValue, isFindOne, sorting}
            Client->>Router:POST /user/search
            Router->>UserController: search_user(searchCriteria, searchValue, isFindOne, sorting)
            UserController->>UserController: verify all parameters is not nulll or empty
            opt some parameter is null or empty
                UserController-->>Router: throw the error "parameters is required"
                Note over Router,Client: JSON Response: {status_code, message, data(if any)}
                Router-->>Client: 400, criteria, value,<br> isFindOne, and sorting are required"
            end
            UserController->>UserController: convert searchCriteria from parameter<br>to pre-defined criteria using if-else statement<br>for only permit to search with id, username, email,and memberSince
            opt searchCriteria not in this list id, username, email,and memberSince
                UserController-->>Router: throw the error "the specified searchCriteria not permit"
                Note over Router,Client: JSON Response: {status_code, message, data(if any)}
                Router-->>Client: 403, "specified searchCriteria not permit"
            end
            Note over UserController, UserModel: search_user(searchCriteria: str, searchValue: str,<br>isFindOne: <True, False>bool, sorting: <"asc", "desc">Sort)
            UserController->>UserModel: search(db, "email", email, false, "asc")
            opt search Failed
                UserModel-->>UserController: throw any error
                UserController-->>Router: throw the error "error occured during search a user"
                Note over Router,Client: JSON Response: {status_code, message, data(if any)}
                Router-->>Client: 500, "the error occured during search a user"
            end
            Note left of UserModel: return only non-sensitive data (user data: userUniqueId,<br>memberSince, userName, email))
            UserModel->>UserController: return array of user object [{...}, {...}, ...] 
            opt any error
                UserController-->>Router: throw the error "internal server error"
                Note over Router,Client: JSON Response: {status_code, message, data(if any)}
                Router-->>Client: 500, "internal server error"
            end
            UserController->>Router: return array of user object [{...}, {...}, ...] 
            Note over Router,Client: JSON Response: {status_code, message, data(if any)}
            Router->>Client: 200, "seach user email successful", data: {users: [{...},{...},{...},...]} 
        end
    else update current user
        rect rgb(252,182,142)
            Note over Router: with body of {Id,dataObject}
            Client->>Router: PUT /user
            Router->>Router: extract the body (whatever it have or don't have)<br> by body parser to parameters
            Router->>UserController: update_current_user(request, updateData, password)
            UserController->>UserController: verify all parameters is not null or empty
            opt some parameter is null or empty
                UserController-->>Router: throw the error "parameters is required"
                Note over Router,Client: JSON Response: {status_code, message, data(if any)}
                Router-->>Client: 400, "request, updateData and password is required"
            end
            Note right of  UserController: as the get_current_user was defined in "read current user"
            UserController->>UserController: this.get_current_user(request)
            UserController->>UserModel: check_password(db, username.lower(), password)
            UserModel->>UserModel: this.search(db, "username", userName, True, "asc")
            opt not found the username
                UserModel->>UserModel: this.search(db, "email", userName, True, "asc")
            end
            opt not found the email
                UserModel-->>UserController: return empty object
                UserController-->>Router: throw the error "user not found"
                Note over Router,Client: JSON Response: {status_code, message, data(if any)}
                Router-->>Client: 401, unauthorized
            end
            UserModel->>UserModel:bcrypt.checkpw(password, user['hashedPassword'])
            opt invalid password
                UserModel-->>UserController: return False
                UserController-->>Router: throw the error "password invalid"
                Note over Router,Client: JSON Response: {status_code, message, data(if any)}
                Router-->>Client: 401, unauthorized
            end
            UserModel->>UserController: return True
            opt if newPassword exist
                UserController->>UserController: verify if newPassword == confirmNewPassword
                opt new password and its confirmation don't match
                    UserController-->>Router: throw the error "new password confirm don't match"
                    Note over Router,Client: JSON Response: {status_code, message, data(if any)}
                    Router-->>Client: 400, "new password confirm don't match"
                end
                UserController->>UserController: bcrypt.hashpw(newPassword, salt?)
            end
            UserController->>UserController: this.get_current_user(request)
            UserController->>UserController: include current user data that doesn't exist in the updateData<br>into updateData
            UserController->>UserController: normalize an email and username to lowercase<br> this.normalize(email, username)
            UserController->>UserModel: update(db, userId, updateData)
            opt
                UserModel-->>UserController: throw any error
                UserController-->>Router: throw the error "error occured during update user"
                Note over Router,Client: JSON Response: {status_code, message, data(if any)}
                Router-->>Client: 500, "error occured during update user"
            end
            UserModel->>UserController: return True
            opt any error
                UserController-->>Router: throw the error "internal server error"
                Note over Router,Client: JSON Response: {status_code, message, data(if any)}
                Router-->>Client: 500, "internal server error"
            end
            UserController->>Router: return True
            Note over Router,Client: JSON Response: {status_code, message, data(if any)}
            Router->>Client: 200, "user updated"
        end
    else delete a user
        rect rgb(247,155,155)
            Note over Router: with body of {Id}
            Client->>Router: DELETE /user
            Router->>Router: extract the body (whatever it have or don't have)<br> by body parser to parameters
            Router->>UserController: delete_user(userId)
            UserController->>UserController: verify userId is not null or empty
            opt userId is null or empty
                UserController-->>Router: throw the error "parameter is required"
                Note over Router,Client: JSON Response: {status_code, message, data(if any)}
                Router-->>Client: 400, "userId is required"
            end
            UserController->>UserModel:get_user_by_id(userId)
            UserModel->>UserModel: verify userId is not null
            opt userId is null or empty
                UserModel-->>UserController: throw the error "parameter is required"
                UserController-->>Router: throw the error "parameter is required"
                Note over Router,Client: JSON Response: {status_code, message, data(if any)}
                Router-->>Client: 400, "userId is required"
            end
            UserController->>UserModel: delete(db, userId)
            UserModel->>UserController: return True
            opt any error
                UserController-->>Router: throw the error "internal server error"
                Note over Router,Client: JSON Response: {status_code, message, data(if any)}
                Router-->>Client: 500, "internal server error"
            end
            UserController->>Router: return True
            Note over Router,Client: JSON Response: {status_code, message, data(if any)}
            Router->>Client: 200, "delete successful"
        end

    end 
    