%%{
    init: {
        "theme":"base",
        "themeVariables": {
            "fontFamily": "system-ui",
            'labelBoxBorderColor': '#ff0000'
        },
        "sequence": { 
            "wrap": true, 
            "width": 180 
        } 
    }
}%%
sequenceDiagram
    participant Client
    participant Sec as Security
    participant Router as UserRouter
    participant BaseCont as BaseController
    participant Cont as UserController extends<br> BaseController
    participant Mongo as MongoObject
    participant BaseModel as BaseModel extends<br> MongoObject
    participant Model as UserModel extends<br> BaseModel

    %% Delete User
    Client->>+Router: DELETE /users/:userId (deleteUserById)
    Note over Sec, Router: this method defined in read.mmd
    Router->>+Sec: Verify Token(token)
    alt if token is invalid
    Note over Sec: the token maybe in Header or Cookies. so this method try to extract the token from the request
        Sec->>Sec: extractToken(request)
    end
    Sec->>Sec: jwt.decode(token)
    opt Token decode error
        Note over Sec, Router: Use the same error class to ensure consistency of error messages 
        Sec-->>Router: throw CredentialsException()
        Router-->>Client: 401, "Could not validate credentials"
    end
    opt Token expired
        Sec-->>Router: throw CredentialsException()
        Router-->>Client: 401, "Could not validate credentials"
    end
    opt Invalid token
        Sec-->>Router: throw CredentialsException()
        Router-->>Client: 401, "Could not validate credentials"
    end
    Sec-->>-Router: decoded user object
    Note over Router : this method defined in create.mmd
    Router->>Router: MethodValidator(allowedMethods)
    opt path not available
        Router-->>Client: 401, "<path> not available"
    end
    opt method not allowed
        Router-->>Client: 405, "<method> not allowed for <path>"
    end
    Router->>+Cont: deleteUser(req, res, next)
    Note over Cont, BaseCont: this method defined in read.mmd
    Cont->>+BaseCont: getCurrentUser(req)
    BaseCont-->>-Cont: User data
    opt user not found
        Cont-->>Router: throw NotFoundError('User not found')
        Router-->>Client: 404, "User not found"
    end
    Cont->>Cont: Destructoring req.body
    opt currentPassword is not in req.body
        Cont-->>Router: throw BadRequestError('currentPassword is required')
        Router-->>Client: 400, "currentPassword is required"
    end
    Cont->>+Model: checkPassword(user.username, currentPassword)
    opt Invalid password
        Model-->>Cont: return false
        Cont-->>Router: throw PasswordError()
        Router-->>Client: 401, "Invalid username or password"
    end
    Model-->>-Cont: return true
    Cont->>+Model: deleteById(userId)
    Model->>+BaseModel: pass call
    BaseModel->>+Mongo: isValidObjectId(userId)
    opt invalid userId
        Mongo-->>BaseModel: false
        BaseModel-->>Model: throw Error('Invalid ObjectId')
        Model-->>Cont: pass error
        Cont-->>Router: next(BadRequestError('Invalid ObjectId'))
        Router-->>Client: 400, "Invalid ObjectId"
    end
    Mongo-->>-BaseModel: true
    BaseModel->>BaseModel: findByIdAndDelete(userId)
    opt any error
        BaseModel-->>Model: throw Error('Error deleting user')
        Model-->>Cont: pass error
        Cont-->>Router: next(error)
        Router-->>Client: 500, "something went wrong"
    end
    BaseModel-->>-Model: Deleted user
    Model-->>-Cont: pass result
    Cont->>Cont: formatResponse(200, 'User deleted successfully', { userId: deletedUser._id })
    Cont-->>-Router: Formatted response
    Router-->>-Client: 200, { status: 200, message: "User deleted successfully", data: { userId: deletedUser._id } }
